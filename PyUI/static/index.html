<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyUI 用户系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
    <script src="https://unpkg.com/axios@0.27.2/dist/axios.min.js"></script>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom right, #e6f7ff, #f0f9ff);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .login-container {
            width: 450px;
            margin: 120px auto;
            padding: 35px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.5s ease-out;
        }
        .header {
            background: linear-gradient(to right, #1890ff, #40a9ff);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .form-container {
            margin-top: 20px;
        }
        .logo {
            height: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-text {
            font-size: 22px;
            font-weight: bold;
        }
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #303133;
            font-size: 24px;
            font-weight: 500;
        }
        .el-button--primary {
            background-color: #1890ff;
            border-color: #1890ff;
            transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
        }
        .el-button--primary:hover {
            background-color: #40a9ff;
            border-color: #40a9ff;
            transform: translateY(-2px);
        }
        .el-input__inner {
            border-radius: 4px;
            padding: 0 40px 0 15px;
            height: 44px;
            line-height: 44px;
        }
        .el-input__prefix {
            left: auto;
            right: 5px;
            color: #909399;
        }
        .el-checkbox {
            color: #606266;
        }
        .el-divider__text {
            color: #909399;
            font-size: 14px;
        }
        .el-button--text {
            color: #1890ff;
        }
        .el-button--text:hover {
            color: #40a9ff;
            text-decoration: underline;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 未登录状态 -->
        <div v-if="!isLoggedIn" class="login-container">
            <div style="text-align: center; margin-bottom: 20px;">
                <div class="logo">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#1890ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7.5 12h9m-9 3h9m-9-6h9m1.5-5a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-16a2 2 0 0 1-2-2v-14a2 2 0 0 1 2-2h2m5.66 0a1 1 0 0 1 .66.76l1.04 4.24h-3.4l1.04-4.24a1 1 0 0 1 .66-.76h2z" />
                    </svg>
                    <span class="logo-text">PyUI</span>
                </div>
                <h2 class="login-title">欢迎登录系统</h2>
            </div>
            
            <el-form :model="loginForm" :rules="loginRules" ref="loginForm" label-width="80px" class="form-container">
                <!-- 用户名输入 -->
                <el-form-item label="账号" prop="username">
                    <el-input 
                        v-model="loginForm.username" 
                        placeholder="请输入用户名"
                        autocomplete="username"
                        prefix-icon="el-icon-user"
                    ></el-input>
                </el-form-item>
                
                <!-- 密码输入 -->
                <el-form-item label="密码" prop="password">
                    <el-input 
                        v-model="loginForm.password" 
                        type="password" 
                        placeholder="请输入密码"
                        autocomplete="current-password"
                        show-password
                        prefix-icon="el-icon-lock"
                    ></el-input>
                </el-form-item>
                
                <!-- 记住我选项 -->
                <el-form-item>
                    <el-checkbox v-model="rememberMe">记住我</el-checkbox>
                </el-form-item>
                
                <!-- 登录按钮 -->
                <el-form-item>
                    <el-button 
                        type="primary" 
                        @click="handleLogin" 
                        style="width: 100%" 
                        :loading="loginLoading"
                    >
                        登录
                    </el-button>
                </el-form-item>
                
                <el-divider>或</el-divider>
                
                <!-- 注册按钮 -->
                <el-button 
                    type="text" 
                    @click="showRegisterDialog = true" 
                    style="width: 100%"
                >
                    注册新账号
                </el-button>
            </el-form>
            
            <!-- 注册对话框 -->
            <el-dialog title="注册账号" :visible.sync="showRegisterDialog" width="500px">
                <el-form :model="registerForm" :rules="registerRules" ref="registerForm" label-width="100px">
                    <el-form-item label="用户名" prop="username">
                        <el-input v-model="registerForm.username" prefix-icon="el-icon-user"></el-input>
                    </el-form-item>
                    <el-form-item label="密码" prop="password">
                        <el-input v-model="registerForm.password" type="password" show-password prefix-icon="el-icon-lock"></el-input>
                    </el-form-item>
                    <el-form-item label="邮箱" prop="email">
                        <el-input v-model="registerForm.email" prefix-icon="el-icon-message"></el-input>
                    </el-form-item>
                </el-form>
                <span slot="footer">
                    <el-button @click="showRegisterDialog = false">取消</el-button>
                    <el-button type="primary" @click="handleRegister" :loading="registerLoading">确认注册</el-button>
                </span>
            </el-dialog>
        </div>
    </div>
    <script>
        // 密码强度验证函数
        const validatePassword = (rule, value, callback) => {
            if (!value) {
                callback(new Error('请输入密码'));
            } else if (value.length < 8) {
                callback(new Error('密码长度至少为8个字符'));
            } else if (!/[A-Z]/.test(value)) {
                callback(new Error('密码必须包含至少一个大写字母'));
            } else if (!/[a-z]/.test(value)) {
                callback(new Error('密码必须包含至少一个小写字母'));
            } else if (!/\d/.test(value)) {
                callback(new Error('密码必须包含至少一个数字'));
            } else {
                callback();
            }
        };
        
        // 设置axios支持会话cookie
        axios.defaults.withCredentials = true;
        
        new Vue({
            el: '#app',
            data() {
                return {
                    isLoggedIn: false,
                    currentUser: {},
                    loginLoading: false,
                    registerLoading: false,
                    showRegisterDialog: false,
                    rememberMe: false,
                    loginForm: { username: '', password: '' },
                    registerForm: { username: '', password: '', email: '' },
                    loginRules: {
                        username: [
                            { required: true, message: '请输入用户名', trigger: 'blur' },
                            { min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur' }
                        ],
                        password: [
                            { required: true, message: '请输入密码', trigger: 'blur' },
                            { min: 6, max: 20, message: '长度在 6 到 20 个字符', trigger: 'blur' }
                        ]
                    },
                    registerRules: {
                        username: [
                            { required: true, message: '请输入用户名', trigger: 'blur' },
                            { min: 3, max: 20, message: '长度在 3 到 20 个字符', trigger: 'blur' }
                        ],
                        password: [
                            { required: true, validator: validatePassword, trigger: 'blur' }
                        ],
                        email: [
                            { required: true, message: '请输入邮箱地址', trigger: 'blur' },
                            { type: 'email', message: '请输入正确的邮箱地址', trigger: ['blur', 'change'] }
                        ]
                    }
                }
            },
            mounted() {
                // 检查本地存储中是否有记住的登录信息
                const savedLogin = localStorage.getItem('rememberedLogin');
                if (savedLogin) {
                    const { username } = JSON.parse(savedLogin);
                    this.loginForm.username = username;
                    this.rememberMe = true;
                }
                
                this.checkLoginStatus();
            },
            methods: {
                checkLoginStatus() {
                    axios.get('/api/user/user')
                        .then(response => {
                            if (response.data.success) {
                                this.isLoggedIn = true;
                                this.currentUser = response.data.data;
                                // 如果已登录，直接跳转到交易信息页面
                                window.location.href = '/trade_info.html';
                            }
                        })
                        .catch(() => {
                            this.isLoggedIn = false;
                        });
                },
                handleLogin() {
                    this.$refs.loginForm.validate(valid => {
                        if (!valid) return;
                        
                        // 如果选择了"记住我"，保存登录信息
                        if (this.rememberMe) {
                            localStorage.setItem('rememberedLogin', JSON.stringify({
                                username: this.loginForm.username
                            }));
                        } else {
                            localStorage.removeItem('rememberedLogin');
                        }
                        
                        this.loginLoading = true;
                        axios.post('/api/user/login', this.loginForm)
                            .then(response => {
                                if (response.data.success) {
                                    this.isLoggedIn = true;
                                    this.currentUser = response.data.data;
                                    this.$message.success('登录成功');
                                    // 登录成功后跳转到交易信息页面
                                    window.location.href = '/trade_info.html';
                                } else {
                                    this.$message.error(response.data.message);
                                }
                            })
                            .catch(error => {
                                console.error('登录错误详情:', error);
                                this.$message.error('登录失败：' + (error.response?.data?.message || error.message || '网络错误'));
                            })
                            .finally(() => {
                                this.loginLoading = false;
                            });
                    });
                },
                handleRegister() {
                    this.$refs.registerForm.validate(valid => {
                        if (!valid) return;
                        this.registerLoading = true;
                        axios.post('/api/user/register', this.registerForm)
                            .then(response => {
                                if (response.data.success) {
                                    this.$message.success('注册成功');
                                    this.showRegisterDialog = false;
                                    this.registerForm = { username: '', password: '', email: '' };
                                    // 自动填充登录表单
                                    this.loginForm.username = response.data.data.username;
                                } else {
                                    this.$message.error(response.data.message);
                                }
                            })
                            .catch(error => {
                                this.$message.error('注册失败：' + (error.response?.data?.message || '网络错误'));
                            })
                            .finally(() => {
                                this.registerLoading = false;
                            });
                    });
                }
            }
        });
    </script>
</body>
</html> 